<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>More Forms</title>
    <style>
        .error {
            color: red;
        }
    </style>
    <script>        // 当字段失去焦点时验证是否为空，并在页面上显示错误消息
        function validateNotEmpty(field) {
            var errorDiv = document.getElementById(field.name + "Error");
            if (field.value.trim() === "") {
                errorDiv.textContent = "This field is required.";
                errorDiv.style.display = "block";
            } else {
                errorDiv.textContent = "";
                errorDiv.style.display = "none";
            }
        }

// 检查电子邮件地址是否在允许的列表中
        function checkEmailAgainstList(emailField) {
            var errorDiv = document.getElementById("emailListError");
            errorDiv.textContent = ""; // 先清空错误消息
            var request = new XMLHttpRequest();
            request.onload = function() {
                if (request.status == 200) {
                    var xmlData = request.responseXML;
                    var emails = xmlData.getElementsByTagName('email');
                    var emailList = Array.from(emails).map(function(node) {
                        return node.textContent.trim().toLowerCase();
                    });
                    if (emailList.indexOf(emailField.value.toLowerCase()) === -1) {
                        errorDiv.textContent = "E-mail is not on the allowed list.";
                    } else {
                        errorDiv.textContent = "E-mail is on the allowed list.";
                    }
                } else {
                    errorDiv.textContent = "Error checking email against list.";
                }
                errorDiv.style.display = errorDiv.textContent ? "block" : "none";
            };
            request.onerror = function() {
                errorDiv.textContent = "Error connecting to the server.";
                errorDiv.style.display = "block";
            };
            request.open('GET', 'validEmails.xml', true);
            request.send();
        }


        // 验证电子邮件格式是否正确
        function validateEmailFormat(emailField) {
            var errorDiv = document.getElementById(emailField.name + "Error");
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailField.value)) {
                errorDiv.textContent = "Please enter a valid email address.";
                errorDiv.style.display = "block";
                return false;
            } else {
                errorDiv.textContent = "";
                errorDiv.style.display = "none";
                return true;
            }
        }

        // 在表单提交前进行所有字段的验证
        function validateForm() {
            var isValid = true;
            var name = document.forms["feedbackForm"]["name"];
            var email = document.forms["feedbackForm"]["email"];
            var comments = document.forms["feedbackForm"]["comments"];

            isValid &= validateNotEmpty(name);
            isValid &= validateNotEmpty(email) && validateEmailFormat(email);
            isValid &= validateNotEmpty(comments);

            if (isValid) {
                // 只有当其他验证通过时才检查电子邮件是否注册
                validateEmailRegistered(email);
            }

            return isValid && !document.getElementById("emailRegisteredError").textContent;
        }
    </script>
</head>
<body>
    <h1>Feedback Form</h1>
    <p>Please fill out this form to help us improve our site.</p>
    <form method="post" action="http://www.deitel.com" onsubmit="return validateForm();">
        <!-- Hidden fields -->
        <p>
            <label>Name:
                <input name="name" type="text" size="25" onblur="validateNotEmpty(this);">
                <span id="nameError" class="error"></span>
            </label>
        </p>
        <p>
            <label>Comments:
                <textarea name="comments" rows="4" cols="36" onblur="validateNotEmpty(this);"></textarea>
                <span id="commentsError" class="error"></span>
            </label>
        </p>
        <p>
            <label>E-mail Address:
                <input name="email" type="email" size="25" onblur="validateEmailFormat(this);">
                <span id="emailError" class="error"></span>
                <span id="emailListError" class="error"></span>
            </label>
        </p>
        <p>
            <strong>Things you liked:</strong><br>
            <label>Site design
                <input name="thingsLiked" type="checkbox" value="Design">
            </label><br>
            <label>Links
                <input name="thingsLiked" type="checkbox" value="Links">
            </label><br>
            <label>Ease of use
                <input name="thingsLiked" type="checkbox" value="Ease">
            </label><br>
            <label>Images
                <input name="thingsLiked" type="checkbox" value="Images">
            </label><br>
            <label>Source code
                <input name="thingsLiked" type="checkbox" value="Code">
            </label>
        </p>
        <p>
            <strong>How did you get to our site?:</strong><br>
            <label>Search engine
                <input name="howSite" type="radio" value="search engine" checked>
            </label><br>
            <label>Links from another site
                <input name="howSite" type="radio" value="link">
            </label><br>
            <label>Deitel.com Web site
                <input name="howSite" type="radio" value="deitel.com">
            </label><br>
            <label>Reference in a book
                <input name="howSite" type="radio" value="book">
            </label><br>
            <label>Other
                <input name="howSite" type="radio" value="other">
            </label>
        </p>
        <p>
            <label>Rate our site:
                <select name="rating">
                    <option>Amazing</option>
                    <option>10</option>
                    <option>9</option>
                    <option>8</option>
                    <option>7</option>
                    <option>6</option>
                    <option>5</option>
                    <option>4</option>
                    <option>3</option>
                    <option>2</option>
                    <option>1</option>
                    <option>Awful</option>
                </select>
            </label>
        </p>
        <p>
            <input type="submit" value="Submit">
            <input type="reset" value="Clear">
        </p>
    </form>
</body>
</html>
